# ---------------------------
# üèóÔ∏è Est√°gio 1: Build da Aplica√ß√£o
# ---------------------------
FROM maven:3.8.8-eclipse-temurin-17 AS build

# Define o diret√≥rio de trabalho dentro do container
WORKDIR /app

# Copia o arquivo pom.xml e baixa as depend√™ncias primeiro (cache inteligente)
COPY pom.xml .

# Baixa depend√™ncias antes de copiar o c√≥digo (melhora cache entre builds)
RUN mvn dependency:go-offline -B

# Copia o c√≥digo-fonte para dentro do container
COPY src ./src

# Compila o projeto e gera o JAR
RUN mvn clean package -DskipTests -DcompilerArgs=-parameters


# ---------------------------
# üöÄ Est√°gio 2: Imagem de Execu√ß√£o (Leve)
# ---------------------------
FROM eclipse-temurin:17-jre-jammy

# Define o diret√≥rio de trabalho
WORKDIR /app

# Copia o JAR gerado do est√°gio anterior
COPY --from=build /app/target/*.jar app.jar

# Exp√µe a porta da aplica√ß√£o (Cloud Run usa vari√°vel PORT, mas 8080 √© padr√£o local)
EXPOSE 8080

# Usa vari√°vel de ambiente do Cloud Run (fallback 8080)
ENV PORT=8080

# Inicia a aplica√ß√£o
ENTRYPOINT ["java", "-jar", "app.jar"]
