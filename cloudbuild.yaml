steps:
  # 1. Empacotar o Spring Boot em um JAR (Executado DENTRO da subpasta 'acervo-api')
  - name: 'maven:3.8.3-jdk-17'
    entrypoint: 'mvn'
    dir: 'acervo-api'
    args: ['clean', 'package', '-DskipTests']

  # 2. Construir a Imagem do Docker (Ajuste Definitivo)
  - name: 'gcr.io/cloud-builders/docker'
    # A CHAVE AQUI: Diga ao Cloud Build para ir para a pasta que cont√©m o Dockerfile
    dir: 'acervo-api'
    args: [
      'build',
      '-t',
      'gcr.io/$PROJECT_ID/acervo-api:$COMMIT_SHA',
      '.'  # O ponto significa 'use esta pasta atual (acervo-api) como contexto'
    ]

  # 3. Enviar a Imagem para o Google Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/acervo-api:$COMMIT_SHA']

  # 4. Implantar a nova Imagem no Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
      'run',
      'deploy',
      'acervo-api',
      '--image',
      'gcr.io/$PROJECT_ID/acervo-api:$COMMIT_SHA',
      '--region',
      'southamerica-east1',
      '--allow-unauthenticated',
      '--platform',
      'managed'
    ]
images:
  - 'gcr.io/$PROJECT_ID/acervo-api:$COMMIT_SHA'