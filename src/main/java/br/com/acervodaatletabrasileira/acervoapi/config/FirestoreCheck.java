package br.com.acervodaatletabrasileira.acervoapi.config;

import com.google.cloud.firestore.Firestore;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.annotation.Id;
import com.google.cloud.spring.data.firestore.repository.config.EnableReactiveFirestoreRepositories;

import java.lang.reflect.Field;
import java.util.Arrays;

@Configuration
@EnableReactiveFirestoreRepositories(basePackages = "br.com.acervodaatletabrasileira.acervoapi.repository")
public class FirestoreCheck {

    private static final Logger log = LoggerFactory.getLogger(FirestoreCheck.class);

    private final Firestore firestore;

    public FirestoreCheck(Firestore firestore) {
        this.firestore = firestore;
    }

    @PostConstruct
    public void verifyConnectionAndModel() {
        verifyFirestoreConnection();
        verifyFirestoreModel(br.com.acervodaatletabrasileira.acervoapi.model.Atleta.class);
    }

    /**
     * Teste simples de conex√£o com o Firestore
     */
    private void verifyFirestoreConnection() {
        try {
            log.info("üîç Verificando conex√£o com o Google Firestore...");

            var collections = firestore.listCollections();
            int count = 0;
            for (var col : collections) {
                count++;
                log.debug("üìÅ Cole√ß√£o detectada: {}", col.getId());
            }

            if (count == 0) {
                log.info("‚úÖ Conectado ao Firestore, mas nenhuma cole√ß√£o foi encontrada ainda.");
            } else {
                log.info("‚úÖ Conex√£o com o Firestore verificada com sucesso ({} cole√ß√µes).", count);
            }

        } catch (Exception e) {
            log.error("‚ùå Erro ao verificar a conex√£o com o Firestore!", e);
        }
    }

    /**
     * Teste extra: verifica se o modelo possui um campo anotado com @Id
     */
    private void verifyFirestoreModel(Class<?> clazz) {
        log.info("üîé Verificando anota√ß√µes do modelo: {}", clazz.getSimpleName());

        Field[] fields = clazz.getDeclaredFields();
        boolean idFound = Arrays.stream(fields)
                .anyMatch(f -> f.isAnnotationPresent(Id.class));

        if (idFound) {
            Field idField = Arrays.stream(fields)
                    .filter(f -> f.isAnnotationPresent(Id.class))
                    .findFirst()
                    .orElse(null);

            log.info("‚úÖ Campo @Id detectado no modelo '{}' ‚Üí nome do campo: '{}', tipo: {}",
                    clazz.getSimpleName(),
                    idField != null ? idField.getName() : "(desconhecido)",
                    idField != null ? idField.getType().getSimpleName() : "(?)"
            );
        } else {
            log.error("‚ùå Nenhum campo com @Id foi encontrado no modelo '{}'.", clazz.getSimpleName());
            log.error("üß© Verifique se a classe '{}' cont√©m um campo como:", clazz.getSimpleName());
            log.error("    @Id\n    private String id;\n");
            log.error("E se a depend√™ncia spring-cloud-gcp-data-firestore est√° corretamente configurada.");
        }
    }
}

